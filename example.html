<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

body {
    font-family: "Helvetica", sans-serif;
}

.bar {
    fill: steelblue;
}

div.tooltip {
    position: absolute;
    text-align: center;
    width: 120px;
    height: 35px;
    padding: 2px;
    font: 12px sans-serif;
    background: lightblue;
    border: 0;
    border-radius: 8px;
    pointer-events: none;
}

</style>
<body>
<h1>Global Food Prices</h1>
<!-- load the d3.js library -->
<script src="d3.js"></script>
<script>
  /*
   * reading data: http://learnjsdata.com/read_data.html
   * nesting data: http://learnjsdata.com/group_data.html
   * Grouped bar chart tutorial: https://bl.ocks.org/mbostock/3887051
   */
  var margin = {top: 20, right: 20, bottom: 30, left: 40},
    width = 1200 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;

  var yearMenu = d3.select('#yearsDropdown');

  var svg = d3.select('body')
    .append('svg')
    .attr('width', width + margin.left + margin.right)
    .attr('height', height + margin.top + margin.bottom)
    .append('g')
    .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

  var div = d3.select('body')
    .append('div')
    .attr('class', 'tooltip')
    .attr('opacity', 0);

  var x0 = d3.scaleBand()
    .rangeRound([0, width])
    .paddingInner(0.1);

  var x1 = d3.scaleBand()
    .padding(0.05);

  var y = d3.scaleLinear()
    .rangeRound([height, 0]);

  var z = d3.scaleOrdinal()
    .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

  /*
   * Read all data from the CSV file;
   * rename every attribute to have easy memorable names; also convert them to the right type;
   * nest data to make the data set better approachable
   */
  d3.csv('data/wfpvam_foodprices.csv',
    function (data) {
      return {
        country: data.adm0_name,
        province: data.adm1_name,
        city: data.mkt_name,
        commodity: data.cm_name,
        currency: data.cur_name,
        market_type: data.pt_name,
        unit: data.um_name,
        year: +data.mp_year,
        month: +data.mp_month,
        price: +data.mp_price
      }
    },
    function (error, data) {
      if (error) throw error;

      var nestedData = d3.nest()
        .key(function (d) {
          return d.year;
        })
        .key(function (d) {
          return d.country;
        })
        .key(function (d) {
          return d.commodity;
        })
        .rollup(function(v) {
          return {
            country: v[0].country,
            commodity: v[0].commodity,
            currency: v[0].currency,
            market_type: v[0].market_type,
            unit: v[0].unit,
            year: v[0].year,
            count: v.length,
            total: d3.mean(v, function(d) { return d.price; })
          }
        })
        /*.rollup(function (v) {
          return d3.mean(v, function (d) {
            return d.price
          })

        })
        /*.key(function(d) {
          if (d.year == 2000) {
            return d.price
          }
        })*/
        .entries(data);

      yearMenu
        .append('select')
        .selectAll('option')
        .data(nestedData)
        .enter()
        .append('option')
        .attr('value', function(d) {
          return d.key;
        })
        .text(function(d) {
          return d.key;
        });

      console.log(nestedData);

      //function onlyUnique(value, index, self) {
      //  return self.indexOf(value.country) === index;
      //}

      //var countries = data.filter(onlyUnique);
      //var keys = data.columns.slice(1);
      //console.log('keys:');
      //console.log(countries);
      x0.domain(data.map(function(d) { return d.country; }));
      //x1.domain(keys).rangeRound([0, x0.bandwidth()]);
      y.domain([0, d3.max(data, function(d) { return d.price})]);

      svg.append('g')
        .selectAll('g')
        
      // data.forEach(function(d) {
      //   d.Jahr = +d.Jahr;
      // });
      //
      // console.log("data", data);
      //
      // var x = d3.scaleBand()
      //   .range([0, width])
      //   .padding(0, 1);
      //
      // var y = d3.scaleLinear()
      //   .range([height, 0]);
      //
      // x.domain(data.map(function(d) {
      //   return d.YEAR;
      // }));
      //
      // y.domain([
      //   d3.min(data, function(d) {
      //     return d.Jahr;
      //   }) * 0.95,
      //   d3.max(data, function (d) {
      //     return d.Jahr;
      //   })
      // ]);
      //
      // svg.selectAll('.bar')
      //   .data(data)
      //   .enter()
      //   .append('rect')
      //   .attr('class', 'bar')
      //   .attr('x', function(d, i) {
      //     return x(d.YEAR);
      //   })
      //   .attr('y', function(d) {
      //     return y(d.Jahr);
      //   })
      //   .attr('width', x.bandwidth())
      //   .attr('height', function(d) {
      //     return height - y(d.Jahr);
      //   })
      //   .on('mouseover', function(d) {
      //     div.transition()
      //       .duration(200)
      //       .style('opacity', .9);
      //
      //     div.html('in the year ' + d.YEAR + '<br/>' + d.Jahr + ' hours of sun')
      //       .style('left', (d3.event.pageX) + 'px')
      //       .style('top', (d3.event.pageY - 28) + 'px')
      //   })
      //   .on('mouseout', function(d) {
      //     div.transition.duration(500)
      //       .style('opacity', 0);
      //   });
      //
      // svg.append('g')
      //   .attr('transform', 'translate(0, ' + height + ')')
      //   .call(d3.axisBottom(x)
      //     .tickValues(x.domain().filter(function(d, i) {
      //       return !(i%5)
      //     }))
      //   );
      //
      // svg.append('g')
      //   .call(d3.axisLeft(y));
    });


</script>
  <div id="yearsDropdown"></div>
</body>